name: CI (Windows) - tests + HQCB-B demo

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install project + dev deps
        shell: pwsh
        run: |
          python -m pip install -U pip
          python -m pip install -e ".[dev]"
          python -m pip install pyyaml matplotlib numpy

      - name: Run unit tests
        shell: pwsh
        run: |
          python -m pytest -q

      - name: Run HQCB-B demo (generate figures)
        shell: pwsh
        env:
          PYTHONUTF8: "1"
          PYTHONIOENCODING: "utf-8"
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          python scripts\hqcb_b_demo.py --config data\cosmology\hqcb_b_toy.yaml

      - name: Verify HQCB-B figures exist
        shell: pwsh
        run: |
          $f1 = "docs/figures/hqcb_b_v_ratio.png"
          $f2 = "docs/figures/hqcb_b_H0_ratio.png"
          if (-not (Test-Path $f1)) { throw "Missing figure: $f1" }
          if (-not (Test-Path $f2)) { throw "Missing figure: $f2" }
          Write-Host "OK: HQCB-B figures generated."