name: CI (Windows) - tests + HQCB-B demo

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install project + dev deps
        shell: pwsh
        run: |
          python -m pip install -U pip
          python -m pip install -e ".[dev]"
          python -m pip install pyyaml matplotlib numpy

      - name: Run unit tests
        shell: pwsh
        run: |
          python -m pytest -q

      - name: Run HQCB-B demo (generate figures)
        shell: pwsh
        env:
          PYTHONUTF8: "1"
          PYTHONIOENCODING: "utf-8"
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          python scripts\hqcb_b_demo.py --config data\cosmology\hqcb_b_toy.yaml

      - name: Verify HQCB-B figures exist
        shell: pwsh
        run: |
          $f1 = "docs/figures/hqcb_b_v_ratio.png"
          $f2 = "docs/figures/hqcb_b_H0_ratio.png"
          if (-not (Test-Path $f1)) { throw "Missing figure: $f1" }
          if (-not (Test-Path $f2)) { throw "Missing figure: $f2" }
          Write-Host "OK: HQCB-B figures generated."
      - name: Run HQCB inference (toy)
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          python scripts\hqcb_infer.py --config data\cosmology\hqcb_infer_toy.yaml --out data\results\hqcb_infer_results.json --figdir docs\figures

      - name: Verify HQCB inference artifacts exist
        shell: pwsh
        run: |
          $j  = "data/results/hqcb_infer_results.json"
          $f1 = "docs/figures/hqcb_infer_gamma_posterior.png"
          $f2 = "docs/figures/hqcb_infer_H0_ratio.png"
          if (-not (Test-Path $j))  { throw "Missing artifact: $j" }
          if (-not (Test-Path $f1)) { throw "Missing artifact: $f1" }
          if (-not (Test-Path $f2)) { throw "Missing artifact: $f2" }
          Write-Host "OK: HQCB inference artifacts generated."
      - name: Run HQCB infer-data (BAO mock)
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          python -m hqcb_hhh infer-data --config data\cosmology\hqcb_infer_data_mock.yaml

      - name: Verify HQCB infer-data artifacts exist
        shell: pwsh
        run: |
          $j  = "data/results/hqcb_infer_data_results.json"
          $f1 = "docs/figures/hqcb_infer_joint_gamma.png"
          if (-not (Test-Path $j))  { throw "Missing artifact: $j" }
          if (-not (Test-Path $f1)) { throw "Missing artifact: $f1" }
          Write-Host "OK: HQCB infer-data artifacts generated."
      - name: Run make_paper_figures (paper-ready)
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          python scripts\make_paper_figures.py

      - name: Verify paper skeleton + copied figures exist
        shell: pwsh
        run: |
          $p1 = "paper/main.tex"
          $p2 = "paper/sections/02_action_field_equations.tex"
          $p3 = "paper/bib/references.bib"
          if (-not (Test-Path $p1)) { throw "Missing: $p1" }
          if (-not (Test-Path $p2)) { throw "Missing: $p2" }
          if (-not (Test-Path $p3)) { throw "Missing: $p3" }

          $f1 = "paper/figures/hqcb_b_v_ratio.png"
          $f2 = "paper/figures/hqcb_b_H0_ratio.png"
          if (-not (Test-Path $f1)) { throw "Missing: $f1" }
          if (-not (Test-Path $f2)) { throw "Missing: $f2" }

          Write-Host "OK: paper skeleton and copied figures exist."